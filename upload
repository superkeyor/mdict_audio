#!/usr/bin/env bash
csd="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"
cd "$csd"

REPO_NAME="mdict_audio"
GITHUB_USER="superkeyor"
DOCKERHUB_USER="superkeyor"
REPO_VISIBILITY="--public"

# ── Per-project overrides ─────────────────────────────────────────────────────
RUN_GIT=true      # true/false: git add + commit + push to GitHub

RUN_DOCKER=true   # true/false: docker hub build + push
DOCKER_CHOICE=""  # ""=ask, "1"=native, "2"=buildx multi-platform, "3"=skip

RUN_REMOTE=false  # true/false: rsync + remote docker build
SSH_LOGIN=""      # e.g. 'ssh -p 2023 parallels@192.168.1.81'
# ─────────────────────────────────────────────────────────────────────────────

# ── 1. Git: commit + push to GitHub ──────────────────────────────────────────
if [[ "$RUN_GIT" == false ]]; then
    echo "Skipping git commit and push."
else
    git add -A
    git commit -m 'update'
    git push git@github.com:${GITHUB_USER}/${REPO_NAME}.git
fi

# ── 2. Docker Hub: build + push ───────────────────────────────────────────────
if [[ "$RUN_DOCKER" == false ]]; then
    echo "Skipping Docker Hub push."
elif [[ $(command -v docker) != "" ]]; then
    if [[ "${REPO_VISIBILITY}" == "--private" ]]; then
        echo "Repo is private. Skipping Docker Hub push."
    else
        if [[ -z "$DOCKER_CHOICE" ]]; then
            echo "Push to Docker Hub ${DOCKERHUB_USER}/${REPO_NAME}:latest?"
            echo "  1) Yes, native platform"
            echo "  2) Yes, multi-platform (linux/amd64,linux/arm64) via buildx"
            echo "  3) No, skip"
            read -p "Choice [1]: " DOCKER_CHOICE
        fi
        DOCKER_CHOICE=${DOCKER_CHOICE:-1}

        if [[ "$DOCKER_CHOICE" == "1" ]]; then
            echo "Building and pushing native platform image..."
            sudo docker build --tag ${DOCKERHUB_USER}/${REPO_NAME}:latest .
            sudo docker image push ${DOCKERHUB_USER}/${REPO_NAME}:latest
        elif [[ "$DOCKER_CHOICE" == "2" ]]; then
            echo "Building and pushing multi-platform image..."
            sudo docker buildx build                 --platform linux/amd64,linux/arm64                 --tag ${DOCKERHUB_USER}/${REPO_NAME}:latest                 --push                 .
        else
            echo "Skipping Docker Hub push."
        fi
    fi
fi

# ── 3. Remote SSH: rsync + build ─────────────────────────────────────────────
if [[ "$RUN_REMOTE" == false ]]; then
    echo "Skipping remote build."
elif [[ -z "$SSH_LOGIN" ]]; then
    echo "Skipping remote build (SSH_LOGIN not set)."
else
    echo "Building remotely via $SSH_LOGIN..."
    port=$(echo "$SSH_LOGIN" | cut -d' ' -f3)
    user=$(echo "$SSH_LOGIN" | cut -d' ' -f4 | cut -d'@' -f1)
    host=$(echo "$SSH_LOGIN" | cut -d' ' -f4 | cut -d'@' -f2)
    folder=/home/$user/App/$REPO_NAME

    # Ensure rsync is available on remote
    ssh -p $port $user@$host "command -v rsync >/dev/null 2>&1 || { echo 'Installing rsync...'; sudo apt-get install -y rsync; }"

    # Sync files
    ssh -p $port $user@$host "mkdir -p $folder"
    rsync -e "ssh -p $port" . $user@$host:$folder/         -avz --delete         --exclude='.git/'         --exclude='__pycache__/'         --exclude='.DS_Store'         --exclude='._*'
        # -avz: archive, verbose, compress

    # Build on remote
    ssh -p $port $user@$host -t "sudo docker build --tag ${REPO_NAME}:latest $folder &&     sudo docker system prune --force && sudo docker image prune --force"
    # -t: allocate a pseudo-terminal

    # Local git tracking of remote deploy
    git add -A
    git commit -m 'remote deploy'
fi
